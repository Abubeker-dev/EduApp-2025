const ADMIN = {
  telegramUsername: "eduapp1850",
  videos: {
    "grade-5": {
      "maths": {
        "chapter-1": [ // All grade 5 maths videos currently in chapter 1
          { title: "Maths Video 1", url: "https://www.youtube.com/embed/dQw4w9WgXcQ?rel=0&modestbranding=1" },
          { title: "Maths Video 2", url: "https://www.youtube.com/embed/3JZ_D3ELwOQ?rel=0&modestbranding=1" },
          { title: "Maths Video 3", url: "https://www.youtube.com/embed/L_jWHffIx5E?rel=0&modestbranding=1" },
          { title: "Maths Video 4", url: "https://www.youtube.com/embed/eY52Zsg-KVI?rel=0&modestbranding=1" },
          { title: "Maths Video 5", url: "https://www.youtube.com/embed/fLexgOxsZu0?rel=0&modestbranding=1" }
        ],
        "chapter-2": [], // Placeholder - add videos here later
        "chapter-3": [],
        "chapter-4": [],
        "chapter-5": [],
        "chapter-6": [],
        "chapter-7": [],
        "chapter-8": [],
        "chapter-9": [],
      },
      "english": {
        "chapter-1": [
          { title: "English Video 1", url: "https://www.youtube.com/embed/QtXby3twMmI?rel=0&modestbranding=1" },
          { title: "English Video 2", url: "https://www.youtube.com/embed/tVj0ZTS4WF4?rel=0&modestbranding=1" },
          { title: "English Video 3", url: "https://www.youtube.com/embed/9bZkp7q19f0?rel=0&modestbranding=1" }
        ],
         "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
      },
      "gs": {
         "chapter-1": [
          { title: "GS Video 1", url: "https://www.youtube.com/embed/6Dh-RL__uN4?rel=0&modestbranding=1" },
          { title: "GS Video 2", url: "https://www.youtube.com/embed/uelHwf8o7_U?rel=0&modestbranding=1" },
          { title: "GS Video 3", url: "https://www.youtube.com/embed/CD-E-LDc384?rel=0&modestbranding=1" }
        ],
         "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
      },
      "ict": {
         "chapter-1": [
          { title: "ICT Video 1", url: "https://www.youtube.com/embed/MZ2hJFO7Ws8?rel=0&modestbranding=1" },
          { title: "ICT Video 2", url: "https://www.youtube.com/embed/y0u9ch6y2EY?rel=0&modestbranding=1" },
          { title: "ICT Video 3", url: "https://www.youtube.com/embed/3YP8zkEUzXQ?rel=0&modestbranding=1" }
        ],
         "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
      },
      "citizenship": {
         "chapter-1": [
          { title: "Citizenship Video 1", url: "https://www.youtube.com/embed/YQHsXMglC9A?rel=0&modestbranding=1" },
          { title: "Citizenship Video 2", url: "https://www.youtube.com/embed/0KSOMA3QBU0?rel=0&modestbranding=1" },
          { title: "Citizenship Video 3", url: "https://www.youtube.com/embed/hT_nvWreIhg?rel=0&modestbranding=1" }
        ],
         "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
      }
    },
    "grade-6": {
       "maths": {
         "chapter-1": [
            { title: "Maths Video 1", url: "https://www.youtube.com/embed/dQw4w9WgXcQ?rel=0&modestbranding=1" },
            { title: "Maths Video 2", url: "https://www.youtube.com/embed/3JZ_D3ELwOQ?rel=0&modestbranding=1" },
            { title: "Maths Video 3", url: "https://www.youtube.com/embed/L_jWHffIx5E?rel=0&modestbranding=1" }
          ],
          "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
       },
       "english": {
         "chapter-1": [
            { title: "English Video 1", url: "https://www.youtube.com/embed/QtXby3twMmI?rel=0&modestbranding=1" },
            { title: "English Video 2", url: "https://www.youtube.com/embed/tVj0ZTS4WF4?rel=0&modestbranding=1" },
            { title: "English Video 3", url: "https://www.youtube.com/embed/9bZkp7q19f0?rel=0&modestbranding=1" }
          ],
           "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
       },
       "ict": {
         "chapter-1": [
            { title: "ICT Video 1", url: "https://www.youtube.com/embed/MZ2hJFO7Ws8?rel=0&modestbranding=1" },
            { title: "ICT Video 2", url: "https://www.youtube.com/embed/y0u9ch6y2EY?rel=0&modestbranding=1" },
            { title: "ICT Video 3", url: "https://www.youtube.com/embed/3YP8zkEUzXQ?rel=0&modestbranding=1" }
          ],
           "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
       },
       "gs": { "chapter-1": [] /* Add G6 GS videos here */ }, // Example: Add subjects even if empty initially
       "citizenship": { "chapter-1": [] /* Add G6 Citizenship videos here */ }
    },
    "grade-7": {
      "maths": {
         "chapter-1": [
            { title: "Maths Video 1", url: "https://www.youtube.com/embed/dQw4w9WgXcQ?rel=0&modestbranding=1" },
            { title: "Maths Video 2", url: "https://www.youtube.com/embed/3JZ_D3ELwOQ?rel=0&modestbranding=1" },
            { title: "Maths Video 3", url: "https://www.youtube.com/embed/L_jWHffIx5E?rel=0&modestbranding=1" },
            { title: "Maths Video 4", url: "https://www.youtube.com/embed/eY52Zsg-KVI?rel=0&modestbranding=1" },
            { title: "Maths Video 5", url: "https://www.youtube.com/embed/fLexgOxsZu0?rel=0&modestbranding=1" }
          ],
          "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
       },
      "ict": {
         "chapter-1": [
            { title: "Unit 1 Part 1", url: "https://www.youtube.com/embed/MZ2hJFO7Ws8?rel=0&modestbranding=1" },
            { title: "Unit 1 Part 2", url: "https://www.youtube.com/embed/y0u9ch6y2EY?rel=0&modestbranding=1" },
            { title: "Review Question on Unit 1", url: "https://www.youtube.com/embed/3YP8zkEUzXQ?rel=0&modestbranding=1" }
          ],
           "chapter-2": [], "chapter-3": [], "chapter-4": [], "chapter-5": [], "chapter-6": [], "chapter-7": [], "chapter-8": [], "chapter-9": [],
       },
       "english": { "chapter-1": [] /* Add G7 English videos here */ },
       "gs": { "chapter-1": [] /* Add G7 GS videos here */ },
       "citizenship": { "chapter-1": [] /* Add G7 Citizenship videos here */ }
    },
     "grade-8": { // Add Grade 8 structure
        "maths": { "chapter-1": [] },
        "english": { "chapter-1": [] },
        "gs": { "chapter-1": [] },
        "ict": { "chapter-1": [] },
        "citizenship": { "chapter-1": [] }
        // Add chapter 2-9 placeholders as needed
     }
  }
};

// --- Helper Functions (deviceId, hashing, access control, date format) ---
function getDeviceId() {
  let id = localStorage.getItem("deviceId");
  if (!id) {
    id = "device-" + Math.random().toString(36).slice(2, 11);
    localStorage.setItem("deviceId", id);
  }
  return id;
}

const deviceId = getDeviceId();
const deviceIdInput = document.getElementById("device-id");
if (deviceIdInput) deviceIdInput.value = deviceId;

const copyDeviceIdBtn = document.getElementById("copy-device-id-btn");
if (copyDeviceIdBtn) {
    copyDeviceIdBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(deviceId);
        alert("Device ID copied!");
      } catch (err) { // Fallback
        try {
            const input = document.createElement("input");
            input.style.position = "absolute"; input.style.left = "-9999px";
            input.value = deviceId; document.body.appendChild(input);
            input.select(); input.setSelectionRange(0, 99999);
            document.execCommand("copy"); document.body.removeChild(input);
            alert("Device ID copied (fallback method)!");
        } catch(fallbackErr) {
            alert("Could not copy Device ID. Please select and copy it manually.");
        }
      }
    });
}

function hashDeviceIdWithYear(deviceId, year) {
  const str = deviceId + year; let hash = 0;
  if (str.length === 0) return hash;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = (hash << 5) - hash + char; hash |= 0;
  }
  return "CODE-" + Math.abs(hash);
}

function saveAccess(code) {
  const expiry = new Date(); expiry.setFullYear(expiry.getFullYear() + 1);
  try {
      localStorage.setItem("eduaccess", JSON.stringify({ deviceId, code, expiry: expiry.toISOString() }));
  } catch (e) { alert("Could not save access info."); }
}

function loadAccess() {
  try {
    const accessData = localStorage.getItem("eduaccess");
    return accessData ? JSON.parse(accessData) : null;
  } catch(e) { localStorage.removeItem("eduaccess"); return null; }
}

function isAccessValid(access) {
  if (!access || typeof access !== 'object') return false;
  if (access.deviceId !== deviceId) return false;
  if (!access.expiry || isNaN(new Date(access.expiry).getTime())) return false;
  return new Date(access.expiry) > new Date();
}

function formatDate(dateStr) {
    try {
        return new Date(dateStr).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    } catch (e) { return "Invalid Date"; }
}

// --- UI Elements Cache ---
const sampleVideoSection = document.getElementById("sample-video-section");
const paymentSection = document.getElementById("payment-section");
const appContent = document.getElementById("app-content");
const accessExpiryEl = document.getElementById("access-expiry");

const gradeView = document.getElementById("grade-view");
const subjectView = document.getElementById("subject-view");
const chapterView = document.getElementById("chapter-view");
const videoView = document.getElementById("video-view");

const gradeList = document.getElementById("grade-list");
const subjectList = document.getElementById("subject-list");
const subjectButtonsContainer = document.getElementById("subject-buttons-container");
const subjectListTitle = document.getElementById("subject-list-title");

const chapterList = document.getElementById("chapter-list");
const chapterButtonsContainer = document.getElementById("chapter-buttons-container");
const chapterListTitle = document.getElementById("chapter-list-title");

const videoListContainer = document.getElementById("video-list");
const videoListTitle = document.getElementById("video-list-title");

const unlockCodeInput = document.getElementById("unlock-code");
const unlockMsg = document.getElementById("unlock-msg");
const telegramBtn = document.getElementById("telegram-btn");
const unlockBtn = document.getElementById("unlock-btn");
const logoutBtn = document.getElementById("logout-btn");

const backToGradesBtn = document.getElementById("back-to-grades");
const backToSubjectsBtn = document.getElementById("back-to-subjects");
const backToChaptersBtn = document.getElementById("back-to-chapters");

// --- State Variables ---
let currentGrade = null;
let currentSubject = null;
let currentChapter = null;

// --- UI Control Functions ---
function showView(viewToShow) {
    gradeView.classList.add("hidden");
    subjectView.classList.add("hidden");
    chapterView.classList.add("hidden");
    videoView.classList.add("hidden");

    if (viewToShow === "grades" && gradeView) gradeView.classList.remove("hidden");
    else if (viewToShow === "subjects" && subjectView) subjectView.classList.remove("hidden");
    else if (viewToShow === "chapters" && chapterView) chapterView.classList.remove("hidden");
    else if (viewToShow === "videos" && videoView) videoView.classList.remove("hidden");
    else gradeView.classList.remove("hidden"); // Default to grades
}

function showAppUI() {
  const access = loadAccess();
  if (isAccessValid(access)) {
    if(sampleVideoSection) sampleVideoSection.classList.add("hidden");
    if(paymentSection) paymentSection.classList.add("hidden");
    if(appContent) appContent.classList.remove("hidden");
    if(accessExpiryEl) accessExpiryEl.textContent = "Access valid until: " + formatDate(access.expiry);
    resetSelections();
    showView("grades");
  } else {
    if(sampleVideoSection) sampleVideoSection.classList.remove("hidden");
    if(paymentSection) paymentSection.classList.remove("hidden");
    if(appContent) appContent.classList.add("hidden");
    if(accessExpiryEl) accessExpiryEl.textContent = "";
  }
}

function resetSelections() {
    currentGrade = null;
    currentSubject = null;
    currentChapter = null;
    document.querySelectorAll(".folder-btn.selected").forEach(b => b.classList.remove("selected"));
}

function formatDisplayName(key) {
    if (!key) return '';
    // Handle grade-X, chapter-X etc.
    if (key.includes('-')) {
        return key.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    // Handle single words like 'maths', 'ict', 'gs'
    if (key === 'gs') return 'G.S';
    if (key === 'ict') return 'ICT';
    return key.charAt(0).toUpperCase() + key.slice(1);
}

function populateSubjects(grade) {
  currentGrade = grade;
  currentSubject = null; // Reset subject when changing grade
  currentChapter = null; // Reset chapter

  if (!subjectButtonsContainer || !subjectListTitle) return;

  subjectButtonsContainer.innerHTML = ""; // Clear previous subjects
  const gradeData = ADMIN.videos[grade];
  const gradeName = formatDisplayName(grade);
  subjectListTitle.textContent = `${gradeName} - Subjects`;

  // Define the desired order of subjects
  const subjectOrder = ["maths", "english", "gs", "ict", "citizenship"];
  const availableSubjects = gradeData ? Object.keys(gradeData) : [];

  if (!gradeData || availableSubjects.length === 0) {
      subjectButtonsContainer.innerHTML = "<p>No subjects available for this grade yet.</p>";
  } else {
      // Filter and sort available subjects according to defined order
      const subjectsToShow = subjectOrder.filter(subj => availableSubjects.includes(subj));
      // Add any subjects present in data but not in predefined order (optional)
      // availableSubjects.forEach(subj => {
      //    if (!subjectsToShow.includes(subj)) subjectsToShow.push(subj);
      // });

      subjectsToShow.forEach((subjectKey) => {
          const btn = document.createElement("button");
          btn.className = "folder-btn subject-btn";
          btn.dataset.folder = subjectKey;
          btn.textContent = formatDisplayName(subjectKey);
          subjectButtonsContainer.appendChild(btn);
      });
       if(subjectsToShow.length === 0) {
           subjectButtonsContainer.innerHTML = "<p>No subjects configured for this grade yet.</p>";
       }
  }

  // Update selected state for the grade button
  document.querySelectorAll("#grade-list .folder-btn.selected").forEach(b => b.classList.remove("selected"));
  const gradeBtn = document.querySelector(`#grade-list .folder-btn[data-folder='${grade}']`);
  if(gradeBtn) gradeBtn.classList.add("selected");

  showView("subjects");
}

function populateChapters(subject) {
    currentSubject = subject;
    currentChapter = null; // Reset chapter

    if (!chapterButtonsContainer || !chapterListTitle || !currentGrade) return;

    chapterButtonsContainer.innerHTML = ""; // Clear previous chapters
    const subjectData = ADMIN.videos?.[currentGrade]?.[currentSubject];
    const gradeName = formatDisplayName(currentGrade);
    const subjectName = formatDisplayName(currentSubject);
    chapterListTitle.textContent = `${gradeName} / ${subjectName} - Chapters`;

    // Static list of chapters 1-9
    const chapterKeys = Array.from({length: 9}, (_, i) => `chapter-${i + 1}`);

    if (!subjectData) { // Check if subject exists for the grade
        chapterButtonsContainer.innerHTML = "<p>No chapters defined for this subject yet.</p>";
    } else {
        chapterKeys.forEach(chapterKey => {
             // Check if this chapter actually has content defined (even if empty array)
             // You might only want to show chapters that have videos:
             // if (subjectData[chapterKey] && subjectData[chapterKey].length > 0) {
             // Or show all chapters 1-9 regardless of content for consistency:
             if (subjectData.hasOwnProperty(chapterKey)) { // Check if key exists in data
                const btn = document.createElement("button");
                btn.className = "folder-btn chapter-btn";
                btn.dataset.folder = chapterKey;
                btn.textContent = formatDisplayName(chapterKey); // Should display "Chapter 1", "Chapter 2" etc.
                chapterButtonsContainer.appendChild(btn);
             } else {
                 // Optionally, display disabled buttons for chapters without data
                 // const btn = document.createElement("button");
                 // btn.className = "folder-btn chapter-btn";
                 // btn.disabled = true; // Make it look inactive
                 // btn.textContent = formatDisplayName(chapterKey);
                 // chapterButtonsContainer.appendChild(btn);
             }
        });
        // Check if *any* chapter buttons were added
        if (chapterButtonsContainer.children.length === 0) {
             chapterButtonsContainer.innerHTML = "<p>No chapters configured for this subject yet.</p>";
        }
    }

    // Update selected state for the subject button
    document.querySelectorAll("#subject-list .folder-btn.selected").forEach(b => b.classList.remove("selected"));
    const subjectBtn = document.querySelector(`#subject-list .folder-btn[data-folder='${subject}']`);
    if(subjectBtn) subjectBtn.classList.add("selected");

    showView("chapters");
}

function loadVideos(chapter) {
    currentChapter = chapter;

    if (!videoListContainer || !videoListTitle || !currentGrade || !currentSubject) return;

    videoListContainer.innerHTML = ""; // Clear previous videos
    const videos = ADMIN.videos?.[currentGrade]?.[currentSubject]?.[currentChapter] || [];

    const gradeName = formatDisplayName(currentGrade);
    const subjectName = formatDisplayName(currentSubject);
    const chapterName = formatDisplayName(currentChapter);
    videoListTitle.textContent = `${gradeName} / ${subjectName} / ${chapterName}`;

    if (videos.length === 0) {
        videoListContainer.innerHTML = "<p>No videos available for this chapter yet.</p>";
    } else {
        // Limit to 5 videos as requested (optional, remove .slice(0, 5) to show all)
        videos.slice(0, 5).forEach((video) => {
            const p = document.createElement("p");
            p.textContent = video.title || "Video"; // Use title or default text

            const iframe = document.createElement("iframe");
            iframe.width = "100%";
            iframe.height = "315";
            iframe.src = video.url;
            iframe.title = video.title || "YouTube video player";
            iframe.setAttribute("frameborder", "0");
            iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share");
            iframe.setAttribute("allowfullscreen", "true");

            videoListContainer.appendChild(p);
            videoListContainer.appendChild(iframe);
        });
         if (videos.length > 5) {
             const notice = document.createElement("p");
             notice.textContent = `(Showing first 5 of ${videos.length} videos for this chapter)`;
             notice.style.fontSize = '0.8em';
             notice.style.color = 'gray';
             videoListContainer.appendChild(notice);
         }
    }

    // Update selected state for the chapter button
    document.querySelectorAll("#chapter-list .folder-btn.selected").forEach(b => b.classList.remove("selected"));
    const chapterBtn = document.querySelector(`#chapter-list .folder-btn[data-folder='${chapter}']`);
    if(chapterBtn) chapterBtn.classList.add("selected");

    showView("videos");
}

// --- Initial Setup & Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {

    showAppUI(); // Initial setup

    // --- Payment/Unlock Listeners ---
    if (telegramBtn) telegramBtn.addEventListener("click", () => window.open(`https://t.me/${ADMIN.telegramUsername}`, "_blank"));

    if (unlockBtn && unlockCodeInput && unlockMsg) {
        unlockBtn.addEventListener("click", () => {
          const userCode = unlockCodeInput.value.trim();
          const year = new Date().getFullYear();
          const expectedCode = hashDeviceIdWithYear(deviceId, year);
          unlockMsg.textContent = "";
          if (!userCode) { unlockMsg.textContent = "Please enter the code."; return; }
          if (userCode === expectedCode) {
            saveAccess(userCode); unlockCodeInput.value = ""; showAppUI();
          } else { unlockMsg.textContent = "Invalid unlock code."; }
        });
    }

    // --- App Navigation Listeners ---
    if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("eduaccess"); resetSelections(); showAppUI();
        });
    }

    // Grade Selection
    if (gradeList) {
        gradeList.addEventListener("click", (event) => {
          if (event.target.classList.contains("grade-btn")) {
            const selectedGrade = event.target.dataset.folder;
            if(selectedGrade) populateSubjects(selectedGrade);
          }
        });
    }

    // Subject Selection
    if (subjectList) {
        subjectList.addEventListener("click", (event) => {
          if (event.target.classList.contains("subject-btn")) {
            const selectedSubject = event.target.dataset.folder;
            if(selectedSubject) populateChapters(selectedSubject);
          }
        });
    }

    // Chapter Selection
    if (chapterList) {
         chapterList.addEventListener("click", (event) => {
          if (event.target.classList.contains("chapter-btn")) {
            const selectedChapter = event.target.dataset.folder;
            if(selectedChapter) loadVideos(selectedChapter);
          }
        });
    }


    // Back Button Listeners
    if (backToGradesBtn) {
        backToGradesBtn.addEventListener("click", () => {
            currentGrade = null; // Clear selection
            document.querySelectorAll("#grade-list .folder-btn.selected").forEach(b => b.classList.remove("selected"));
            showView("grades");
        });
    }

    if (backToSubjectsBtn) {
        backToSubjectsBtn.addEventListener("click", () => {
             currentSubject = null; // Clear selection
             document.querySelectorAll("#subject-list .folder-btn.selected").forEach(b => b.classList.remove("selected"));
             showView("subjects"); // Assumes currentGrade is still valid
        });
    }

    if (backToChaptersBtn) {
        backToChaptersBtn.addEventListener("click", () => {
            currentChapter = null; // Clear selection
             document.querySelectorAll("#chapter-list .folder-btn.selected").forEach(b => b.classList.remove("selected"));
             showView("chapters"); // Assumes currentGrade and currentSubject are still valid
        });
    }

}); // End DOMContentLoaded
